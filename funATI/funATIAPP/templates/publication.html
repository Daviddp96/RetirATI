{% extends 'base.html' %}
{% load static %}

{% block title %}Publicación - FunATI{% endblock %}

{% block page_title %}Publicación{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
<link rel="stylesheet" href="{% static 'css/muro.css' %}">
<link rel="stylesheet" href="{% static 'css/follows.css' %}">
{% endblock %}

{% block content %}
<!-- Publicación principal -->
<div class="post">
    <div class="post-header">
        <a href="{% url 'funATIAPP:profile_detail' publication.profile.id %}" class="profile-link" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
            {% if publication.profile.avatar %}
                <img src="{{ publication.profile.avatar.url }}" alt="{{ publication.profile.user.username }}" class="post-avatar" />
            {% else %}
                <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ publication.profile.user.username }}" class="post-avatar" />
            {% endif %}
            <span class="post-username">{{ publication.profile.user.get_full_name|default:publication.profile.user.username }}</span>
            <span class="post-handle">@{{ publication.profile.user.username }}</span>
        </a>
        <span class="post-time">{{ publication.created_at|timesince }} atrás</span>
    </div>
    <div class="post-content">{{ publication.content }}</div>
    {% if publication.media %}
    <div class="post-media-placeholder">
        <div class="media-preview">
            <img src="{{ publication.media.url }}" alt="Imagen publicación" class="publication-img" />
        </div>
    </div>
    {% endif %}
    <div class="post-actions">
        <button class="post-action">
          <svg class="action-icon" viewBox="0 0 24 24">
            <path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l3.5-7 3.5 7H4zm10.5-7l3.5 7h-7l3.5-7z"/>
          </svg>
          <span>0</span>
        </button>
        <button class="post-action">
          <svg class="action-icon" viewBox="0 0 24 24">
            <path d="M10 3h4v18h-4V3zm7 3h4v15h-4V6zM3 6h4v15H3V6z" />
          </svg>
          <span>0</span>
        </button>
        <button class="post-action">
          <svg class="action-icon" viewBox="0 0 24 24">
            <path d="M8 10v12h8V10H8zM4 8h16v4H4V8zm10-6v4h-4V2h4z" />
          </svg>
          <span>0</span>
        </button>
    </div>
</div>
<!-- Sección de comentarios -->
<div class="comments-section container" style="margin-top: 32px;">
    <h3 style="margin-bottom: 16px;">Comentarios</h3>
    {% if user.is_authenticated %}
    <form method="post" class="funar comment-form" style="margin-bottom: 24px;">
        {% csrf_token %}
        <div class="funar-flex">
            {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" class="post-avatar" />
            {% else %}
                <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ user.username }}" class="post-avatar" />
            {% endif %}
            <span class="span-funar comment-contenteditable" id="comment-content" contenteditable="true">Escribe un comentario...</span>
            <input type="hidden" name="content" id="hidden-comment-content" />
            <input type="hidden" name="parent" id="comment-parent-id" value="">
        </div>
        <div class="buton-flex" style="position: relative; min-height: 50px;">
            <div style="margin-left: auto;">
                <button type="submit" class="button-funar" id="funar-btn">Comentar</button>
            </div>
        </div>
    </form>
    {% endif %}
    {% for comment in comments %}
    {% if not comment.parent %}
    <div class="post" style="margin-bottom: 16px;" id="comment-{{ comment.id }}">
        <div class="post-header">
            <a href="{% url 'funATIAPP:profile_detail' comment.user.profile.id %}" class="profile-link" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
                {% if comment.user.profile.avatar %}
                    <img src="{{ comment.user.profile.avatar.url }}" alt="{{ comment.user.username }}" class="post-avatar" />
                {% else %}
                    <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ comment.user.username }}" class="post-avatar" />
                {% endif %}
                <span class="post-username">{{ comment.user.username }}</span>
            </a>
            <span class="post-time">{{ comment.created_at|timesince }} atrás</span>
        </div>
        <div class="post-content">{{ comment.content }}</div>
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 8px;">
            <button class="reply-btn button-funar" onclick="showReplyForm('{{ comment.id }}')">Responder</button>
        </div>
        <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display:none;">
            <form method="post" class="funar reply-form" style="margin-bottom: 16px;">
                {% csrf_token %}
                <div class="funar-flex">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" class="post-avatar" />
                    {% else %}
                        <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ user.username }}" class="post-avatar" />
                    {% endif %}
                    <span class="span-funar reply-contenteditable" contenteditable="true">Escribe una respuesta...</span>
                    <input type="hidden" name="content" class="hidden-reply-content" />
                    <input type="hidden" name="parent" value="{{ comment.id }}">
                </div>
                <div class="buton-flex" style="position: relative; min-height: 50px;">
                    <div style="margin-left: auto;">
                        <button type="submit" class="button-funar" id="funar-btn-reply-{{ comment.id }}">Responder</button>
                    </div>
                </div>
            </form>
        </div>
        {% include "replies_recursive.html" with replies=comment.replies.all parent_margin=32 %}
    </div>
    {% endif %}
    {% empty %}
        <p>No hay comentarios aún.</p>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/publication.js' %}"></script>
{% endblock %}
